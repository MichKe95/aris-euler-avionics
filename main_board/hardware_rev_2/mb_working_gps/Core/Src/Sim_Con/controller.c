//
// Created by Tun Kapgen on 05.06.20.
//

#include "Sim_Con/controller.h"

/* In this file, all the controller related function as the controller itself will be defined */

void init_coeff(control_data_t *control_data){
    /* The coefficients are sorted in the following way: Gain 1, Gain 2, Gain 3, Optimal Trajectory*/
    const double coeff0[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000002855198029010456660541467439670886, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000022434547591999674984476927547988733638, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000060626080456613692531805404534147004948487, 0.000000000000000000000000000000000000000000000000000000000000000000000000000040131827239647007489478463905518371163659197, 0.000000000000000000000000000000000000000000000000000000000000000000000000082381372111772502765512638584290562726921605986, -0.000000000000000000000000000000000000000000000000000000000000000000000064446177296471145389894187385178176726819258376013, -0.000000000000000000000000000000000000000000000000000000000000000000170648124751636573457657778315533313103485198772664935, 0.000000000000000000000000000000000000000000000000000000000000000029670564292608260228719087309728666722981687803580713660, 0.000000000000000000000000000000000000000000000000000000000000342112282514995292172917359925710442368626507970200032415183, 0.000000000000000000000000000000000000000000000000000000000185736374294079587533485834664387785302229463727922291774220671, -0.000000000000000000000000000000000000000000000000000000529372426055879325979178603803659458256520282109407369565601951591, -0.000000000000000000000000000000000000000000000000000757719295339455328638941817069297375013928179354703627678667657016311, 0.000000000000000000000000000000000000000000000000509963237325789263611287574262637544439771553165898921296278717016069491, 0.000000000000000000000000000000000000000000001853245067197482785714507534417890329227396276195441075028158456209576883559, 0.000000000000000000000000000000000000000000054582502283063412676251027737814842924589057599000557779961162028899359727715, -0.000000000000000000000000000000000000003719004676611021841107562843522962739095496469856532292541274066144589526127847364, -0.000000000000000000000000000000000001390592893132817832098874164300261022626083141716622723639380467059513627886854064570, 0.000000000000000000000000000000007331956831333866024515565766412817733453121600939304664060617945469580955156011501435559, 0.000000000000000000000000000002605526877984738093465928768662930276129467452555587316404014738068746087809428053222449151, -0.000000000000000000000000015757784447310027819498414188048704972792107245861965335682855658539620012648097002738722949289, 0.000000000000000000000004107125323515949737194744639178101628261672625282675018312916856606797910700379361514933407306671, 0.000000000000000000028301760530987915980587744031349387527054929339513213788943890580895867969957180321216583251953125000, -0.000000000000000049941478066171064389585779688937978138476622279751798716418420553964097052812576293945312500000000000000, 0.000000000000045381196872161723899836808525165236879344351356158071553181798662990331649780273437500000000000000000000000, -0.000000000026864560927253753860962285394512773489122947623286563612055033445358276367187500000000000000000000000000000000, 0.000000011048852662236913319459173860644790599039311018714215606451034545898437500000000000000000000000000000000000000000, -0.000003202737536518728965229422731009201186225254787132143974304199218750000000000000000000000000000000000000000000000000, 0.000644417484719104582784054979782695227186195552349090576171875000000000000000000000000000000000000000000000000000000000, -0.085836382072206535154279549715283792465925216674804687500000000000000000000000000000000000000000000000000000000000000000, 6.811696911004294641145406785653904080390930175781250000000000000000000000000000000000000000000000000000000000000000000000, -243.829508280754083671126863919198513031005859375000000000000000000000000000000000000000000000000000000000000000000000000000};
    const double coeff1[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000092271867746409616829508519661, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000733804907017596939984047003123856, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000002017835192841953761578118309009067010, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000001404305183404872912930795208231207182533, 0.000000000000000000000000000000000000000000000000000000000000000000000000000002718885220786782666638534718987821027576535, -0.000000000000000000000000000000000000000000000000000000000000000000000000002325709724561830937655883774445124206601437721, -0.000000000000000000000000000000000000000000000000000000000000000000000005735966311862537075475513927945162658309450186805, 0.000000000000000000000000000000000000000000000000000000000000000000001363188505914105472314280291077466619761344017479406, 0.000000000000000000000000000000000000000000000000000000000000000011860337111397067519961464113451711355621807638442366081, 0.000000000000000000000000000000000000000000000000000000000000005801552980333941631874951596315091333299468522567083353786, -0.000000000000000000000000000000000000000000000000000000000019054993490757513848398717321905410979976980154628353904414343, -0.000000000000000000000000000000000000000000000000000000025818360476567287540574177576423594216584819791601765354508553819, 0.000000000000000000000000000000000000000000000000000019514362052260691996545842359062766223981606091875193125326103043535, 0.000000000000000000000000000000000000000000000000065280531723217619156926685076256510441412209163097110418224638851269634, -0.000000000000000000000000000000000000000000000000604351723885349030182755235966703259949560916318533701568044923436547800, -0.000000000000000000000000000000000000000000133051688460896471590530794980946240991479488990506192549715761087568760752676, -0.000000000000000000000000000000000000000046666448205653930852266875562299973782749502327530667156433127660783172495349131, 0.000000000000000000000000000000000000262662030993206514551557942808181473499219827805328832554945401798250960395654370177, 0.000000000000000000000000000000000091198380503120013615193475499171694050732463353886910127770921554647570410405313411352, -0.000000000000000000000000000000560798020234520439734237595809279712303818242162931248335470065917362148139328672374892548, 0.000000000000000000000000000141687131154755101711174687969972597095283925224006515995089884770119291023792590378249656169, 0.000000000000000000000001003942715855646484939080370815504630495162443338581553208132768014761160291214991957531310617924, -0.000000000000000000001747086371852287594498953078225983984264707510101445984290486485024374019303650129586458206176757812, 0.000000000000000001565893186845782626157236691777045684844761381104437294314868367450799269136041402816772460937500000000, -0.000000000000000914098982619853204256697861213761580871192571721983721744209105963818728923797607421875000000000000000000, 0.000000000000371000348812135909086887268059437893820157877700083304262079764157533645629882812500000000000000000000000000, -0.000000000106324461022774128145652053314322658256196874049237521830946207046508789062500000000000000000000000000000000000, 0.000000021210309852880384846724706911225144523314156685955822467803955078125000000000000000000000000000000000000000000000, -0.000002810259257536875658232359415089618437377794180065393447875976562500000000000000000000000000000000000000000000000000, 0.000222615472740686422574094005533140716579509899020195007324218750000000000000000000000000000000000000000000000000000000, -0.011089248821326691887834137162371916929259896278381347656250000000000000000000000000000000000000000000000000000000000000};
    const double coeff2[POLY_DEG+1] = {-0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000000058492367008588254053997812136190, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000465064872126945360434055497179571532, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000001278502171363752430279705601551008690130, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000889235506556413490772220154229816330118063, 0.000000000000000000000000000000000000000000000000000000000000000000000000001722682174128098109589535986945679492255282545, -0.000000000000000000000000000000000000000000000000000000000000000000000001472261150785001319833757773006120540875289220741, -0.000000000000000000000000000000000000000000000000000000000000000000003633261892814382991894803932784356449643835395279237, 0.000000000000000000000000000000000000000000000000000000000000000000861714203741239752858196302981444422996081123498889208, 0.000000000000000000000000000000000000000000000000000000000000007510223863089150641650215884932669556398703437005005460358, 0.000000000000000000000000000000000000000000000000000000000003675336257229436240087206223514812734003953916685914405943005, -0.000000000000000000000000000000000000000000000000000000012063909213236179741531602205551390216066827450654182555860537545, -0.000000000000000000000000000000000000000000000000000016346755120538144355564653998724512169266144893424867200149062976475, 0.000000000000000000000000000000000000000000000000012356999643828768116863621383323113572500869670751237846173917573456522, 0.000000000000000000000000000000000000000000000041328588989199455315109045035463249997779766239622077478697522121727504136, -0.000000000000000000000000000000000000000000000400111026173059715726079391844406265778547245111238447271115171751470480983, -0.000000000000000000000000000000000000000084246630450439343179903493857044193052547284682704305633307990801864672273232438, -0.000000000000000000000000000000000000029488857376393319194953525482078858423940402157098700760176052905439081881760506698, 0.000000000000000000000000000000000166359050224307513766529755758017212529616601414299210437608985561341398464222763813901, 0.000000000000000000000000000000057592321127765500321980592368693538651823062173271291135292225165382368352927781375051597, -0.000000000000000000000000000355241209243982762156126331989901906065215863207886866773826531512486654970119082097568252721, 0.000000000000000000000000090149366113949156478101053992428111909859297834567948961691183282750067934374627043325745034963, 0.000000000000000000000635823901689506605066858013618811680410277618847514355876005334722300688099494436755776405334472656, -0.000000000000000001107469903883521849597043841086541243727171866554292133100201311890486977063119411468505859375000000000, 0.000000000000000993237973499397934860310917162726640014937078138057557907814043574035167694091796875000000000000000000000, -0.000000000000580132566106483275161760436799555633465529103087732210042304359376430511474609375000000000000000000000000000, 0.000000000235572605664327741350977630737945772709807101819023955613374710083007812500000000000000000000000000000000000000, -0.000000067540685629625508173859253779891531621615285985171794891357421875000000000000000000000000000000000000000000000000, 0.000013477746199867931073011415032958382198557956144213676452636718750000000000000000000000000000000000000000000000000000, -0.001786099292233161691181853036880511353956535458564758300781250000000000000000000000000000000000000000000000000000000000, 0.141498777291041738513044379033090081065893173217773437500000000000000000000000000000000000000000000000000000000000000000, -5.038892279798164786086545063881203532218933105468750000000000000000000000000000000000000000000000000000000000000000000000};
    const double coeff3[POLY_DEG+1] = {0.000000000000000000000000000000000000000000000000000000000000000000000000000000000000021149837661156098747631339873465006, -0.000000000000000000000000000000000000000000000000000000000000000000000000000000000127990338794184997384724458747272143443, 0.000000000000000000000000000000000000000000000000000000000000000000000000000000204163276957649007356869942849062743351263, 0.000000000000000000000000000000000000000000000000000000000000000000000000000121352268027596993239185505978196200554504340, -0.000000000000000000000000000000000000000000000000000000000000000000000000326823528025126969682164122607957981918467997795, -0.000000000000000000000000000000000000000000000000000000000000000000000452090266982265979509163631069709541111779610048317, 0.000000000000000000000000000000000000000000000000000000000000000000230648383374077992242794152036421807089968977448633537, 0.000000000000000000000000000000000000000000000000000000000000001172936794564610022206336345175203408214849304326415082618, 0.000000000000000000000000000000000000000000000000000000000000896222080186544986467344796967028572368408403546218048038789, -0.000000000000000000000000000000000000000000000000000000001402058049795760073138317619596125083049153211254569772469537497, -0.000000000000000000000000000000000000000000000000000003711769086032619862564681084897716099019924464749807667396551924460, -0.000000000000000000000000000000000000000000000000001557810233949360052205020694247584908389896367761636012700640369550032, 0.000000000000000000000000000000000000000000000006405854378531450562522406296606239607930372315519892825222974841310413512, 0.000000000000000000000000000000000000000000011021497901902899513094738186531601306172312160519564339169494509315443967892, -0.000000000000000000000000000000000000000002777963222300249855563828692908942107475323248000323120040965409510312123146737, -0.000000000000000000000000000000000000028396848163130699592803666303100343176423593696000652868033615192743698275656258912, -0.000000000000000000000000000000000016681290511696901269208811957761904349100497727048965153201665791845708316807382885065, 0.000000000000000000000000000000057781427854553496408401606179449447872691278626606920829608898009505428016338479300061104, 0.000000000000000000000000000061801682552972095845366322049357827036856204828349992874449552802384396000970681606112577811, -0.000000000000000000000000141340701535373008252441002365154828735403891351732395141315445861985265751936680089784204028547, -0.000000000000000000000099219337773283401718262473430188243447154669631162703912619213117429772808009147411212325096130371, 0.000000000000000000464032219327773024755508693924215519607323804824076593500414844584156526252627372741699218750000000000, -0.000000000000000567870258895399044251251233300028221613447705715810309712310299801174551248550415039062500000000000000000, 0.000000000000388975097108144997044048302867078355086506713522709333119564689695835113525390625000000000000000000000000000, -0.000000000168676532439211987393734050116682852971106143513679853640496730804443359375000000000000000000000000000000000000, 0.000000047603095145126198117447528356666053284129702660720795392990112304687500000000000000000000000000000000000000000000, -0.000008630247910355650836958761595862910098730935715138912200927734375000000000000000000000000000000000000000000000000000, 0.000965665838297516030373779383211285676225088536739349365234375000000000000000000000000000000000000000000000000000000000, -0.064304266220492400929487075700308196246623992919921875000000000000000000000000000000000000000000000000000000000000000000, 3.112294400559890039659194371779449284076690673828125000000000000000000000000000000000000000000000000000000000000000000000, 6.794548726961759932407858286751434206962585449218750000000000000000000000000000000000000000000000000000000000000000000000};

    memcpy(control_data->poly_coeff[0], coeff0, sizeof(coeff0));
    memcpy(control_data->poly_coeff[1], coeff1, sizeof(coeff1));
    memcpy(control_data->poly_coeff[2], coeff2, sizeof(coeff2));
    memcpy(control_data->poly_coeff[3], coeff3, sizeof(coeff3));
}

void compute_control_input(control_data_t *control_data, flight_phase_detection_t *flight_phase_detection){
    if ((flight_phase_detection->flight_phase == COASTING) &&
        ((flight_phase_detection->mach_regime == SUBSONIC) || (flight_phase_detection->mach_regime == TRANSONIC)) &&
        (flight_phase_detection->mach_number < CONTROL_ACTIVATION_MACH_NUMBER) && (!control_data->apogee_approach_phase)) {

        /* caluclate Gains and Reference velocity for given altitude AGL */
        evaluate_polyfit(control_data);

        /* Calculate Velocity Error */
        compute_reference_error(control_data);

        /* Calculate Control Input */
        control_data->control_input = (float)(-control_data->gains[0] * control_data->reference_error
                - control_data->gains[1] * control_data->integrated_error
                - control_data->gains[2] * (control_data->control_input - OPT_TRAJ_CONTROL_INPUT)
                + control_data->control_input);

        /* Check that the control input is between 0 and 1 */
        control_data->control_input = fmaxf(0, fminf(control_data->control_input, 1));

        /* Compute boundaries for the antiwindup */
        compute_antiwindup_boundaries(control_data);

        /* Compute the integrated error */
        control_data->integrated_error = fmaxf(control_data->lowerboundary_aw, fminf(control_data->integrated_error
        + DELTA_T * control_data->reference_error, control_data->upperboundary_aw));

        /* Check if the apogee approach phase was entered */
        check_apogee_approach_phase(control_data, flight_phase_detection);
    }
    else {
        /* This part of the controller is accessed, if the controller should not be operational or if the rocket is the apogee approach phase*/
        /* Airbrakes need to be retracted to prevent entanglement with the parachutes */
        control_data_reset(control_data);
        if (control_data->apogee_approach_phase == true) {
            evaluate_polyfit(control_data);
            compute_reference_error(control_data);
        }
    }
}


void control_data_reset(control_data_t *control_data){
    control_data->control_input = 0;
    control_data->reference_error = 0;
    control_data->integrated_error = 0;
}

void control_data_init(control_data_t *control_data){
    control_data_reset(control_data);

    control_data->lowerboundary_aw = 0;
    control_data->upperboundary_aw = 0;

    control_data->safety_counter = 0;
    control_data->apogee_approach_phase = false;

    init_coeff(control_data);

    for(int i = 0; i < NUM_GAINS; i++){
        control_data->gains[i] = 0;
    }
}

/* Does the Polynomial Calculation of the reference velocity */
void evaluate_polyfit(control_data_t *control_data) {
    /* For Speed */
    double x_placeholder = 0;

    /* Reset gains */
    for (int i = 0; i < NUM_GAINS; i++) {
        control_data->gains[i] = 0;
    }

    /* Reset ref_velocity_placeholder*/
    double ref_velocity_placeholder = 0;

    /* For loop */
    for (int i = 0; i < POLY_DEG + 1; ++i) {
        x_placeholder = pow(control_data->sf_ref_altitude_AGL, (double)(POLY_DEG - i));
        control_data->gains[0] += control_data->poly_coeff[0][i] * x_placeholder;
        control_data->gains[1] += control_data->poly_coeff[1][i] * x_placeholder;
        control_data->gains[2] += control_data->poly_coeff[2][i] * x_placeholder;
        ref_velocity_placeholder += (control_data->poly_coeff[3][i] * x_placeholder);
    }
    control_data->ref_velocity = (float)ref_velocity_placeholder;
}

void compute_antiwindup_boundaries(control_data_t *control_data) {
    control_data->upperboundary_aw = fmaxf(M_AW *
            (CONTROL_DEACTIVATION_ALTITUDE_AGL - control_data->sf_ref_altitude_AGL), MIN_BOUNDARAY_AW);
    if (CONTROL_DEACTIVATION_ALTITUDE_AGL < control_data->sf_ref_altitude_AGL) {
        control_data->upperboundary_aw = 0;
    }
    control_data->lowerboundary_aw = - control_data->upperboundary_aw;
}

void compute_reference_error(control_data_t *control_data) {
    if (control_data->ref_velocity < 0) {
        control_data->reference_error = control_data->sf_velocity;
    }
    else{
        control_data->reference_error = control_data->sf_velocity - control_data->ref_velocity;
    }
}

void check_apogee_approach_phase(control_data_t *control_data, flight_phase_detection_t *flight_phase_detection){
    /* if n positive samples are counted, the apogee approach phase is entered */
    if (flight_phase_detection->mach_number < CONTROL_DEACTIVATION_MACH_NUMBER) {
        control_data->safety_counter += 1;
    }

    /* Check if the apogee approach phase should be entered*/
    if (control_data->safety_counter >= SAFETY_COUNTER_THRESHOLD) {
        control_data->apogee_approach_phase = true;
    }
}

//void save_evaluated_polyfits_to_file(control_data_t *control_data){
//    int lin_num = 10000;
//    FILE *fptr;
//    float delta_lin = (float)TARGET_AGOGEE / (float)lin_num;
//    fptr = fopen ("plotting/data/coeff_data.csv", "w+");
//    for (int j = 0; j < lin_num+1; j++){
//        control_data->sf_ref_altitude_AGL = delta_lin * j;
//        evaluate_polyfit(control_data);
//        fprintf(fptr, "%f,%f,%f,%f,%f\n", control_data->sf_ref_altitude_AGL,
//                control_data->ref_velocity, control_data->gains[0], control_data->gains[1], control_data->gains[2]);
//    }
//    fprintf(fptr,"\n");
//    fclose(fptr);
//}

void compute_test_control_input(control_data_t *control_data){
    float control_input = 0.0f;
    if(TEST_CONTROLLER_USE_VELOCITY){
        control_input = 0.5f + 0.5f * control_data->sf_velocity / TEST_CONTROLLER_MAX_VELOCITY;
    }
    else {
        control_input = (float)(control_data->sf_ref_altitude_AGL / (float)TEST_CONTROLLER_MAX_ALTITUDE);
    }
    control_data->control_input = fmaxf(fminf(control_input, 1), 0);
}
